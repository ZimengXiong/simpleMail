services:
  postgres:
    image: postgres:16
    container_name: simplemail-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-simplemail}
      POSTGRES_USER: ${POSTGRES_USER:-simplemail}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  seaweed-master:
    image: chrislusf/seaweedfs
    container_name: simplemail-seaweed-master
    command: master -ip=seaweed-master -port=9333 -mdir=/data
    volumes:
      - seaweed_master_data:/data
    restart: unless-stopped

  seaweed-volume:
    image: chrislusf/seaweedfs
    container_name: simplemail-seaweed-volume
    command: volume -mserver=seaweed-master:9333 -port=8080 -dir=/data
    volumes:
      - seaweed_volume_data:/data
    depends_on:
      - seaweed-master
    restart: unless-stopped

  seaweed-filer:
    image: chrislusf/seaweedfs
    container_name: simplemail-seaweed-filer
    command: filer -master=seaweed-master:9333 -s3 -s3.port=8333 -s3.config=/etc/seaweedfs/s3.json
    volumes:
      - ./deploy/seaweedfs:/etc/seaweedfs:ro
      - seaweed_filer_data:/data
    depends_on:
      - seaweed-master
      - seaweed-volume
    ports:
      - '8333:8333'
      - '8888:8888'
    restart: unless-stopped

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: simplemail-api
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      PORT: 3000
      API_ADMIN_TOKEN: ${API_ADMIN_TOKEN:?API_ADMIN_TOKEN is required}
      NODE_ENV: production
      APP_BASE_URL: ${APP_BASE_URL:?APP_BASE_URL is required}
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:?FRONTEND_BASE_URL is required}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL:?OIDC_ISSUER_URL is required}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:?OIDC_CLIENT_ID is required}
      OIDC_REQUIRED_EMAIL: ${OIDC_REQUIRED_EMAIL:?OIDC_REQUIRED_EMAIL is required}
      OIDC_REQUIRED_SUBJECT: ${OIDC_REQUIRED_SUBJECT:-}
      SEAWEED_S3_ENDPOINT: ${SEAWEED_S3_ENDPOINT:-http://seaweed-filer:8333}
      SEAWEED_REGION: ${SEAWEED_REGION:-us-east-1}
      SEAWEED_BUCKET: ${SEAWEED_BUCKET:-simplemail}
      SEAWEED_ACCESS_KEY_ID: ${SEAWEED_ACCESS_KEY_ID:?SEAWEED_ACCESS_KEY_ID is required}
      SEAWEED_SECRET_ACCESS_KEY: ${SEAWEED_SECRET_ACCESS_KEY:?SEAWEED_SECRET_ACCESS_KEY is required}
      SEAWEED_FORCE_PATH_STYLE: 'true'
    depends_on:
      - postgres
      - seaweed-filer
    ports:
      - '3000:3000'
    restart: unless-stopped

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: simplemail-worker
    command: ["node", "dist/worker/run.js"]
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      NODE_ENV: production
      SEAWEED_S3_ENDPOINT: ${SEAWEED_S3_ENDPOINT:-http://seaweed-filer:8333}
      SEAWEED_REGION: ${SEAWEED_REGION:-us-east-1}
      SEAWEED_BUCKET: ${SEAWEED_BUCKET:-simplemail}
      SEAWEED_ACCESS_KEY_ID: ${SEAWEED_ACCESS_KEY_ID:?SEAWEED_ACCESS_KEY_ID is required}
      SEAWEED_SECRET_ACCESS_KEY: ${SEAWEED_SECRET_ACCESS_KEY:?SEAWEED_SECRET_ACCESS_KEY is required}
      SEAWEED_FORCE_PATH_STYLE: 'true'
    depends_on:
      - postgres
      - seaweed-filer
      - api
      - worker-migrate
    restart: unless-stopped

  worker-migrate:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: simplemail-worker-migrate
    command: ["node", "dist/worker/migrate.js"]
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
    depends_on:
      - postgres
    restart: 'no'

  migrate:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: simplemail-migrate
    command: ["node", "dist/scripts/migrate.js"]
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
    depends_on:
      - postgres
    restart: 'no'

volumes:
  postgres_data:
  seaweed_master_data:
  seaweed_volume_data:
  seaweed_filer_data:
